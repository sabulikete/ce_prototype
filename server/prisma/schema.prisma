generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  ADMIN
  STAFF
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INVITED
}

enum InviteStatus {
  PENDING
  EXPIRED
  REVOKED
  ACCEPTED
}

enum ContentType {
  ANNOUNCEMENT
  ACTIVITY
  MEMO
  EVENT
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  MEMBER
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String?
  password_hash String
  role          Role
  unit_id       String?
  status        UserStatus @default(ACTIVE)
  
  tickets           Ticket[]
  billingStatements BillingStatement[]
  createdInvites    Invite[] @relation("CreatedInvites")
  sentInvites       Invite[] @relation("SentInvites")
}

model Invite {
  id         Int       @id @default(autoincrement())
  email      String
  name       String?
  role       Role
  unit_id    String?
  token_hash String
  expires_at DateTime
  used_at    DateTime?
  created_by Int
  creator    User      @relation("CreatedInvites", fields: [created_by], references: [id])
  created_at DateTime  @default(now())
  status     InviteStatus @default(PENDING)
  revoked_at DateTime?
  reminder_count Int      @default(0)
  last_sent_at   DateTime @default(now())
  last_sent_by   Int?
  sender         User?    @relation("SentInvites", fields: [last_sent_by], references: [id])
  pending_email_key String? @unique

  reminders InviteReminder[]
}

/// Source of truth for invite resend history. Each row represents one resend attempt.
model InviteReminder {
  id         Int      @id @default(autoincrement())
  invite_id  Int
  invite     Invite   @relation(fields: [invite_id], references: [id], onDelete: Cascade)
  sent_by    Int
  sent_at    DateTime @default(now())
  channels   String   /// JSON array of delivery channels used, e.g. ["email"] or ["email","sms"]
  success    Boolean  @default(true)
  error_code String?  /// Provider error code if delivery failed

  @@index([invite_id, sent_at])
}

model Content {
  id           Int           @id @default(autoincrement())
  type         ContentType
  title        String
  body         String        @db.Text
  status       ContentStatus @default(DRAFT)
  visibility   Visibility    @default(PUBLIC)
  is_pinned    Boolean       @default(false)
  created_at   DateTime      @default(now())
  published_at DateTime?
  
  event        Event?
}

model Event {
  content_id Int      @id
  content    Content  @relation(fields: [content_id], references: [id])
  start_at   DateTime
  end_at     DateTime
  location   String
  
  tickets    Ticket[]
}

model Ticket {
  id            Int       @id @default(autoincrement())
  user_id       Int
  user          User      @relation(fields: [user_id], references: [id])
  event_id      Int
  event         Event     @relation(fields: [event_id], references: [content_id])
  code_hash     String
  checked_in_at DateTime?
  voided_at     DateTime?
  created_at    DateTime  @default(now())
  
  @@index([event_id, user_id, checked_in_at, voided_at])
}

model BillingStatement {
  id         Int      @id @default(autoincrement())
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id])
  file_path  String
  period     DateTime @db.Date
  created_at DateTime @default(now())
}
